@using System
@using Litlog
@using Litlog.Models
@model List<Litlog.Models.DiarioEntryViewModel>

@{
    ViewData["Title"] = "Diário de leituras";
    string dateFormat = "dd MMM yyyy";
}

<h2>Diary</h2>

@if (Model == null || !Model.Any())
{
    <p>No entries yet.</p>
}
else
{
    <div class="diario-list">
        @foreach (var entry in Model)
        {
            var diario = entry.Diario;
            var livro = diario?.Livro;
            var comentarios = entry.Comentarios ?? new List<Comentario>();
            <div class="diario-item" style="display:flex; gap:16px; align-items:flex-start; padding:18px 12px; border-bottom:1px solid rgba(255,255,255,0.05);">
                <div class="diario-cover" style="flex:0 0 48px;">
                    @if (livro != null)
                    {
                        <a asp-action="Detalhes" asp-controller="Livros" asp-route-id="@livro.Id">
                            <img src="@livro.CapaUrl" alt="@livro?.Titulo" class="cover-img" style="width:48px; height:72px; object-fit:cover; border-radius:3px;" />
                        </a>
                    }
                </div>

                <div class="diario-main" style="flex:1;">
                    <div class="diario-header" style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
                        <div class="diario-title" style="font-weight:700; font-size:1.1rem; color:#fff;">
                            @if (livro != null)
                            {
                                <a asp-action="Detalhes" asp-controller="Livros" asp-route-id="@livro.Id" style="color:inherit; text-decoration:none;">@livro.Titulo</a>
                                <span style="color:#bbb; font-weight:600; margin-left:8px;">@((livro.Ano.HasValue && livro.Ano > 0) ? livro.Ano.ToString() : "")</span>
                            }
                            else
                            {
                                <span>Unknown book</span>
                            }
                        </div>

                        <div class="diario-meta" style="display:flex; align-items:center; gap:12px; margin-left:auto; color:#bfc9d1;">
                            @* Rating stars *@
                            <div class="diario-rating" title="Rating">
                                @{
                                    var nota = diario?.Nota ?? 0.0;
                                    int full = (int)Math.Floor(nota);
                                    bool half = (nota - full) >= 0.5;
                                    int totalStars = 5;
                                }
                                <span style="color:#2ecc71;">
                                    @for (int s = 1; s <= totalStars; s++)
                                    {
                                        if (s <= full)
                                        {
                                            <span aria-hidden="true">★</span>
                                        }
                                        else if (s == full + 1 && half)
                                        {
                                            <span aria-hidden="true">☆</span>
                                        }
                                        else
                                        {
                                            <span aria-hidden="true" style="opacity:0.25;">★</span>
                                        }
                                    }
                                </span>
                            </div>

                            <div class="diario-watched" style="color:#b3c6e7; font-size:0.95rem;">
                                Watched @diario?.DataLeitura.ToString(dateFormat)
                            </div>
                        </div>
                    </div>

                    @* Comment / review text *@
                    @if (comentarios != null && comentarios.Any())
                    {
                        foreach (var c in comentarios)
                        {
                            <div class="diario-comment comentario" style="margin-top:6px; color:#e1e1e1;">
                                <div style="margin-bottom:8px; color:#c7d3e3;">@c.Conteudo</div>
                                <div style="font-size:0.85rem; color:#9fb0c8;">
                                    <span style="margin-left:16px;">— @c.Autor</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="diario-no-comment" style="margin-top:8px; color:#9fb0c8;">
                            <em>No review</em>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
